<meta name='viewport' content='width=device-width, initial-scale=1'/><!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Mini Messenger</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{margin:0;font-family:Arial;background:#f0f2f5}
header{background:#1877f2;color:#fff;padding:14px;text-align:center;font-size:20px}
.box{padding:20px}
input,button{
  width:100%;padding:12px;margin:8px 0;
  border-radius:6px;border:1px solid #ccc;font-size:16px
}
button{background:#1877f2;color:white;border:none}
img{width:100px;height:100px;border-radius:50%;object-fit:cover;margin-bottom:10px}
.hidden{display:none}
</style>
</head>

<body>

<header>Mini Messenger</header>

<!-- LOGIN -->
<div class="box" id="loginBox">
  <button onclick="googleLogin()">Login with Google</button>
</div>

<!-- PROFILE SETUP -->
<div class="box hidden" id="profileBox">
  <img id="dp">
  <input type="file" id="photoInput">
  <input type="text" id="name" placeholder="Your name">
  <input type="text" id="username" placeholder="Unique username">
  <button onclick="saveProfile()">Save Profile</button>
</div>

<!-- DONE -->
<div class="box hidden" id="doneBox">
  <h3>Profile Ready âœ…</h3>
  <p id="info"></p>
</div>

<!-- FIREBASE SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

<script>
/* ðŸ”¥ Firebase Config */
const firebaseConfig = {
  apiKey: "AIzaSyBqoF5S18F_lHuQpNW63IOzgGnvYVzUi_4",
  authDomain: "minimessenger-5787e.firebaseapp.com",
  projectId: "minimessenger-5787e",
  storageBucket: "minimessenger-5787e.appspot.com",
  appId: "1:938479935598:web:d5b353e75757e39e2e467f"
};

firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();
const provider = new firebase.auth.GoogleAuthProvider();

let currentUser = null;

/* âœ… GOOGLE LOGIN (REDIRECT â€“ mobile safe) */
function googleLogin(){
  auth.signInWithRedirect(provider);
}

/* âœ… HANDLE REDIRECT RESULT */
auth.getRedirectResult()
.then(result=>{
  if(result.user){
    currentUser = result.user;
    afterLogin();
  }
}).catch(err=>{
  alert(err.message);
});

/* âœ… CHECK LOGIN STATE */
auth.onAuthStateChanged(user=>{
  if(user){
    currentUser = user;
    afterLogin();
  }
});

/* LOAD PROFILE */
function afterLogin(){
  document.getElementById("loginBox").classList.add("hidden");
  db.collection("users").doc(currentUser.uid).get().then(doc=>{
    document.getElementById("profileBox").classList.remove("hidden");
    document.getElementById("name").value = currentUser.displayName || "";
    document.getElementById("dp").src = currentUser.photoURL || "";
    if(doc.exists){
      document.getElementById("username").value = doc.data().username;
    }
  });
}

/* SAVE PROFILE */
function saveProfile(){
  const name = document.getElementById("name").value.trim();
  const username = document.getElementById("username").value.trim().toLowerCase();
  const file = document.getElementById("photoInput").files[0];

  if(!name || !username) return alert("All fields required");

  db.collection("usernames").doc(username).get().then(doc=>{
    if(doc.exists && doc.data().uid !== currentUser.uid){
      alert("Username already taken âŒ");
    } else {
      uploadPhoto(file, url=>{
        db.collection("users").doc(currentUser.uid).set({
          name,
          username,
          photo:url,
          createdAt:Date.now()
        });
        db.collection("usernames").doc(username).set({
          uid: currentUser.uid
        });
        done(name, username);
      });
    }
  });
}

/* UPLOAD DP */
function uploadPhoto(file, cb){
  if(!file) return cb(currentUser.photoURL || "");
  const ref = storage.ref("profiles/"+currentUser.uid);
  ref.put(file).then(()=>{
    ref.getDownloadURL().then(cb);
  });
}

/* FINISH */
function done(name, username){
  document.getElementById("profileBox").classList.add("hidden");
  document.getElementById("doneBox").classList.remove("hidden");
  document.getElementById("info").innerText =
    `Name: ${name}\nUsername: @${username}`;
}
</script>

</body>
</html>